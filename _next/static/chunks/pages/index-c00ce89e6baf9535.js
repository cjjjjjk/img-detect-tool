(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[332],{1642:e=>{e.exports={style:{fontFamily:"'Geist Mono', 'Geist Mono Fallback'",fontStyle:"normal"},className:"__className_c7f111",variable:"__variable_c7f111"}},6760:(e,t,a)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return a(7944)}])},7798:e=>{e.exports={style:{fontFamily:"'Geist', 'Geist Fallback'",fontStyle:"normal"},className:"__className_9ecf55",variable:"__variable_9ecf55"}},7944:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>g});var l=a(7876),n=a(4232),r=a(7798),s=a.n(r),o=a(1642),i=a.n(o);let d=(0,n.forwardRef)((e,t)=>{let{onFileSelect:a,isWidthCollapsed:r,onFilesChange:s,mode:o,onModeChange:i}=e,[d,c]=(0,n.useState)(!1),[u,x]=(0,n.useState)(0),[m,h]=(0,n.useState)(r),[g,p]=(0,n.useState)([]),[b,f]=(0,n.useState)(1),[y,w]=(0,n.useState)(null),v=Math.ceil(g.length/50),j=(b-1)*50,N=(0,n.useMemo)(()=>g.slice(j,j+50),[g,b]),k=e=>{let t=(e-1)*50;f(e),w(t),a(g[t])};(0,n.useImperativeHandle)(t,()=>({nextImage(){if(null!=y)if(y===j+50-1){if(b<v){let e=b+1,t=(e-1)*50;f(e),S(g[t],t)}}else S(N[y-j+1],y+1)},prevImage(){if(null!=y)if(y===j){if(b>1){let e=b-1,t=Math.min((e-1)*50+50-1,g.length-1);f(e),S(g[t],t)}}else S(N[y-j-1],y-1)}})),(0,n.useEffect)(()=>{g.length&&h(r)},[r]);let M=async e=>{if(!e)return;c(!0),x(0);let t=0,a=Array.from(e).filter(e=>e.type.startsWith("image/")),l=setInterval(()=>{t<80&&x(t+=2)},100);try{await new Promise(e=>setTimeout(e,2e3)),clearInterval(l),x(100),setTimeout(()=>{c(!1),p(e=>{let t=[...e,...a];return s(t),t}),f(1),a.length>0&&S(a[0],0)},500)}catch(e){clearInterval(l),c(!1)}finally{}},S=(e,t)=>{null!=t&&w(t),a(e)};return(0,l.jsxs)("div",{children:[!m&&(0,l.jsxs)("div",{className:"p-2 bg-gray-300 rounded mb-2 text-sm text-gray-800",children:[(0,l.jsxs)("label",{className:"mr-3 cursor-pointer",children:[(0,l.jsx)("input",{type:"radio",value:"detection",checked:"detection"===o,onChange:()=>i("detection"),className:"mr-1"}),"Detection"]}),(0,l.jsx)("br",{}),(0,l.jsxs)("label",{className:"cursor-pointer",children:[(0,l.jsx)("input",{type:"radio",value:"segmentation",checked:"segmentation"===o,onChange:()=>i("segmentation"),className:"mr-1"}),"Segmentation"]})]}),(0,l.jsxs)("div",{className:"border-2 border-dashed border-gray-400 px-3 py-4 rounded-xl text-center cursor-pointer hover:border-blue-500 hover:bg-gray-100/30 transition-colors",onDragOver:e=>e.preventDefault(),onDrop:e=>{e.preventDefault(),M(e.dataTransfer.files)},onClick:()=>{var e;return null==(e=document.getElementById("fileInput"))?void 0:e.click()},children:[(0,l.jsx)("input",{id:"fileInput",type:"file",accept:"image/*",multiple:!0,webkitdirectory:"true",className:"hidden",onChange:e=>M(e.target.files)}),m?(0,l.jsx)("p",{className:"text-gray-700 font-medium",children:"Select"}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("p",{className:"text-gray-700 font-medium",children:"Select Image Folder"}),(0,l.jsx)("p",{className:"text-xs text-gray-500",children:"or drag and drop"})]})]}),d?(0,l.jsxs)("div",{className:"mt-4 p-4 text-center",children:[(0,l.jsx)("p",{className:"text-gray-600 mb-2",children:"Uploading..."}),(0,l.jsx)("div",{className:"w-full bg-gray-300 rounded-full h-2.5",children:(0,l.jsx)("div",{className:"bg-blue-600 h-2.5 rounded-full transition-all duration-300 ease-in-out",style:{width:"".concat(u,"%")}})}),(0,l.jsxs)("p",{className:"mt-2 text-sm text-gray-500",children:[u,"%"]})]}):g.length>0?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:"mt-4 flex flex-col gap-1 max-h-[70vh] overflow-y-auto px-1",children:N.map((e,t)=>(0,l.jsxs)("div",{className:"flex items-center justify-between cursor-pointer rounded p-1.5 ".concat(j+t==y?"bg-blue-100 border border-blue-300 text-blue-800":"text-gray-700 hover:bg-gray-100"),onClick:()=>S(e,j+t),children:[(0,l.jsx)("div",{className:"flex items-center gap-2 flex-1 overflow-hidden",children:(0,l.jsx)("span",{className:"text-sm truncate font-medium",children:e.name})}),!m&&(0,l.jsx)("span",{className:"text-xs shrink-0 bg-gray-500 text-white rounded-sm px-1 font-bold",children:(e=>{let t=e.split(".");return t.length>1?".".concat(t.pop()):""})(e.name)}),!m&&(0,l.jsx)("button",{className:"ml-2 px-2 py-1 text-gray-400 text-xs rounded hover:text-red-600 hover:cursor-pointer font-bold",onClick:e=>{e.stopPropagation(),(e=>{let t=g.filter((t,a)=>a!==e);p(t),s(t),b>Math.ceil(t.length/50)&&f(Math.max(1,b-1)),y===e?0===t.length?(a(null),w(null)):e>=t.length?S(t[t.length-1],t.length-1):S(t[e],e):y&&y>e&&w(y-1)})(j+t)},children:"X"})]},j+t))}),v>1&&(0,l.jsxs)("div",{className:"mt-4 flex justify-center items-center",children:[(0,l.jsx)("button",{onClick:()=>k(b-1),disabled:1===b,className:"px-2 py-1 mx-1 rounded bg-gray-300 disabled:opacity-50",children:"◀"}),(()=>{let e=[],t=Math.max(1,b-Math.floor(2.5)),a=Math.min(v,t+5-1);a-t+1<5&&(t=Math.max(1,a-5+1));for(let n=t;n<=a;n++)e.push((0,l.jsx)("button",{onClick:()=>k(n),className:"h-8 w-8 rounded-full mx-1 text-xs font-semibold ".concat(b===n?"bg-blue-600 text-white":"bg-gray-300 text-gray-800 hover:bg-gray-400/50"),children:n},n));return e})(),(0,l.jsx)("button",{onClick:()=>k(b+1),disabled:b===v,className:"px-2 py-1 mx-1 rounded bg-gray-300 disabled:opacity-50",children:"▶"})]})]}):null]})}),c=e=>{let{imageName:t,maskData:a,imageSize:r}=e,s=(0,n.useRef)(null);return(0,n.useEffect)(()=>{let e=s.current,t=null==e?void 0:e.getContext("2d");if(!t||!e)return;if(!a){t.fillStyle="black",t.fillRect(0,0,e.width,e.height);return}let l=document.createElement("canvas");l.width=a.width,l.height=a.height;let n=l.getContext("2d");n&&(n.putImageData(a,0,0),n.globalCompositeOperation="source-in",n.fillStyle="white",n.fillRect(0,0,l.width,l.height),n.globalCompositeOperation="destination-over",n.fillStyle="black",n.fillRect(0,0,l.width,l.height),t.imageSmoothingEnabled=!1,t.fillStyle="black",t.fillRect(0,0,e.width,e.height),t.drawImage(l,0,0,e.width,e.height))},[a,r]),(0,n.useEffect)(()=>{let e=s.current;e&&r.naturalW>1&&(e.style.aspectRatio="".concat(r.naturalW," / ").concat(r.naturalH))},[r]),(0,l.jsxs)("div",{className:"p-4 border rounded mt-4 overflow-hidden min-h-[30vh] max-h-[80vh] flex flex-col bg-white/50",children:[(0,l.jsx)("h2",{className:"font-semibold mb-2 w-full text-gray-800",children:"Segmentation Mask Preview"}),(0,l.jsxs)("p",{className:"text-sm mb-2 text-black",children:["File: ",(0,l.jsx)("strong",{className:"text-black",children:t||"N/A"})]}),(0,l.jsx)("div",{className:"flex-grow overflow-y-auto border border-gray-300 rounded bg-black flex justify-center items-center",children:(0,l.jsx)("canvas",{ref:s,className:"w-full h-auto max-h-full object-contain",style:{imageRendering:"pixelated"},width:r.naturalW>1?r.naturalW:300,height:r.naturalH>1?r.naturalH:150})}),(0,l.jsx)("div",{className:"mt-4 flex flex-col gap-2",children:(0,l.jsxs)("button",{onClick:()=>{if(!a||!t)return;let e=document.createElement("canvas");e.width=a.width,e.height=a.height;let l=e.getContext("2d");if(!l)return;l.putImageData(a,0,0),l.globalCompositeOperation="source-in",l.fillStyle="white",l.fillRect(0,0,e.width,e.height),l.globalCompositeOperation="destination-over",l.fillStyle="black",l.fillRect(0,0,e.width,e.height);let n=t.split(".").slice(0,-1).join("."),r=e.toDataURL("image/png"),s=document.createElement("a");s.href=r,s.download="".concat(n,".png"),s.click()},className:"px-3 py-2 bg-blue-600 text-white rounded w-full font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:!t||!a,children:["Download ",t.split(".").slice(0,-1).join(".")||"mask",".png"]})})]})};function u(e){if("segmentation"===e.mode)return(0,l.jsx)(c,{imageName:e.imageName,maskData:e.maskData,imageSize:e.imageSize});let{annotations:t,onAnnotationsChange:a,imageName:r,imageSize:s,classes:o,allImageFiles:i,onBulkAnnotationsUpdate:d,keypointCount:u}=e,[x,m]=(0,n.useState)(!1),h=async e=>{let t=e.target.files;if(!t||0===t.length)return;m(!0);let a=Array.from(t).filter(e=>e.name.endsWith(".txt")),l=new Map,n=e=>new Promise((t,a)=>{let l=new Image,n=URL.createObjectURL(e);l.onload=()=>{t({w:l.naturalWidth,h:l.naturalHeight}),URL.revokeObjectURL(n)},l.onerror=e=>{a(e),URL.revokeObjectURL(n)},l.src=n});for(let e of a)try{let t=e.name.split(".").slice(0,-1).join("."),a=i.find(e=>e.name.split(".").slice(0,-1).join(".")===t);if(!a){console.warn("No matching image found for label: ".concat(e.name));continue}let{w:r,h:s}=await n(a);if(r<=1||s<=1)continue;let d=(await e.text()).split("\n").filter(e=>""!==e.trim()),c=[];for(let e of d){let t=e.split(" ").map(Number),a=5+3*u,l=u>0?a:5;if(t.length<l){console.warn("Skipping line: Expected ".concat(l," parts, got ").concat(t.length));continue}if(u>0&&t.length<a){console.warn("Skipping line: Mismatch keypoint count. Expected ".concat(a," parts, got ").concat(t.length));continue}let[n,i,d,x,m]=t,h=o.find(e=>e.id===n);if(!h)continue;let g=x*r,p=m*s,b=i*r-g/2,f=d*s-p/2,y=[];if(u>0)for(let e=0;e<u;e++){let a=t[5+3*e],l=t[5+3*e+1],n=t[5+3*e+2];0===n?y.push(null):y.push({x:Math.round(a*r),y:Math.round(l*s)})}let w={id:crypto.randomUUID(),classId:h.id,className:h.name,box:{x:Math.round(b),y:Math.round(f),w:Math.round(g),h:Math.round(p)},keypoints:y};c.push(w)}c.length>0&&l.set(a.name,c)}catch(t){console.error("Failed to process label file ".concat(e.name,":"),t)}l.size>0?(d(l),alert("Successfully imported and applied ".concat(l.size," label file(s) (Note: Labels may be ignored if keypoint count doesn't match current settings)."))):alert("No valid label files found or matched."),m(!1),e.target&&(e.target.value="")};return(0,l.jsxs)("div",{className:"p-4 border rounded mt-4 overflow-hidden min-h-[30vh] max-h-[80vh] flex flex-col bg-white/50",children:[(0,l.jsx)("input",{type:"file",id:"labelInput",webkitdirectory:"true",multiple:!0,className:"hidden",onChange:h,accept:".txt"}),(0,l.jsxs)("h2",{className:"font-semibold mb-2 w-full text-gray-800 flex justify-between",children:["Output Data (Current Image)",(0,l.jsx)("button",{onClick:()=>{var e;return null==(e=document.getElementById("labelInput"))?void 0:e.click()},className:"px-3 py-1 bg-green-600 text-white rounded  font-semibold hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:x||0===i.length,children:x?"Importing...":"▲ Upload"})]}),(0,l.jsxs)("p",{className:"text-sm mb-2  text-black",children:["File: ",(0,l.jsx)("strong",{className:"text-black",children:r||"N/A"})]}),(0,l.jsx)("div",{className:"flex-grow overflow-y-auto border border-gray-300 rounded",children:(0,l.jsxs)("table",{className:"w-full text-sm border-collapse",children:[(0,l.jsx)("thead",{className:"sticky top-0",children:(0,l.jsxs)("tr",{className:"bg-gray-200 text-gray-700",children:[(0,l.jsx)("th",{className:"border-b border-gray-500 px-3 py-2 text-center",children:"#"}),(0,l.jsx)("th",{className:"border-b border-gray-500 px-3 py-2 text-left",children:"Class"}),(0,l.jsx)("th",{className:"border-b border-gray-500 px-3 py-2 text-left",children:"Box (x,y,w,h)"}),u>0&&(0,l.jsx)("th",{className:"border-b border-gray-500 px-3 py-2 text-left",children:"Keypoints (x,y)"}),(0,l.jsx)("th",{className:"border-b border-gray-500 px-3 py-2 text-center",children:"Action"})]})}),(0,l.jsxs)("tbody",{children:[t.map((e,n)=>(0,l.jsxs)("tr",{className:"hover:bg-gray-100/50",children:[(0,l.jsx)("td",{className:"border-b border-gray-400 px-3 text-black py-1.5 text-center font-mono text-xs",children:n+1}),(0,l.jsxs)("td",{className:"border-b border-gray-400 px-3 text-black py-1.5",children:[e.className," (",e.classId,")"]}),(0,l.jsx)("td",{className:"border-b border-gray-400 px-3 text-black py-1.5 font-mono text-xs",children:"(".concat(e.box.x,", ").concat(e.box.y,") [").concat(e.box.w,"x").concat(e.box.h,"]")}),u>0&&(0,l.jsx)("td",{className:"border-b border-gray-400 px-3 text-black py-1.5 font-mono text-xs",children:e.keypoints.map((e,t)=>(0,l.jsxs)("span",{className:"mr-1 ".concat(e?"":"text-gray-400"),children:["[",t+1,": ",e?"".concat(e.x,",").concat(e.y):"N/A","]"]},t))}),(0,l.jsx)("td",{className:"border-b border-gray-400 px-3 text-black py-1.5 text-center",children:(0,l.jsx)("button",{className:"bg-red-500 text-white px-2 py-0.5 rounded text-xs font-semibold hover:bg-red-600",onClick:()=>{var l;return l=e.id,void a(t.filter(e=>e.id!==l))},children:"Del"})})]},e.id)),0===t.length&&(0,l.jsx)("tr",{children:(0,l.jsx)("td",{colSpan:u>0?5:4,className:"text-center p-4 text-gray-500",children:"No annotations yet."})})]})]})}),(0,l.jsx)("div",{className:"mt-4 flex flex-col gap-2",children:(0,l.jsxs)("button",{onClick:()=>{if(!r)return void alert("No image selected.");let e=(()=>{let{naturalW:e,naturalH:a}=s;if(e<=1||a<=1)return"";let l=[];for(let n of t){let{box:t,keypoints:r,classId:s}=n,o=(t.x+t.w/2)/e,i=(t.y+t.h/2)/a,d=t.w/e,c=t.h/a,x=[s,o.toFixed(6),i.toFixed(6),d.toFixed(6),c.toFixed(6)];if(u>0){r.length!==u||r.some(e=>null===e);let t=r.flatMap(t=>t?[(t.x/e).toFixed(6),(t.y/a).toFixed(6),2]:["0.000000","0.000000",0]);for(let e=r.length;e<u;e++)t.push("0.000000","0.000000",0);x.push(...t)}l.push(x.join(" "))}return l.join("\n")})(),a=r.split(".").slice(0,-1).join("."),l=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(l),o=document.createElement("a");o.href=n,o.download="".concat(a,".txt"),o.click(),URL.revokeObjectURL(n)},className:"px-3 py-2 bg-blue-600 text-white rounded w-full font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:!r||0===t.length,children:["Download ",r.split(".").slice(0,-1).join(".")||"labels",".txt"]})})]})}let x=e=>{let{file:t,imageSize:a,maskData:r,onMaskChange:s,onImageLoad:o}=e,[i,d]=(0,n.useState)(8),[c,u]=(0,n.useState)(!1),[x,m]=(0,n.useState)("paint"),h=(0,n.useRef)(null),g=(0,n.useRef)(null),p=(0,n.useRef)(null),b=(0,n.useRef)(null),f=(0,n.useRef)(null),[y,w]=(0,n.useState)({w:1,h:1}),v=t?URL.createObjectURL(t):null;(0,n.useEffect)(()=>{let e=g.current;e&&a.naturalW>1&&a.naturalH>1&&(e.width=a.naturalW,e.height=a.naturalH,p.current=e.getContext("2d",{willReadFrequently:!0}))},[a.naturalW,a.naturalH]),(0,n.useEffect)(()=>{let e=p.current;if(e)if(r){let t=document.createElement("canvas");t.width=a.naturalW,t.height=a.naturalH;let l=t.getContext("2d");l&&(l.putImageData(r,0,0),e.clearRect(0,0,a.naturalW,a.naturalH),e.globalCompositeOperation="source-over",l.globalCompositeOperation="source-in",l.fillStyle="white",l.fillRect(0,0,a.naturalW,a.naturalH),e.drawImage(t,0,0))}else e.clearRect(0,0,a.naturalW,a.naturalH)},[r,t]);let j=e=>{if(!f.current||!h.current||y.w<=1||y.h<=1)return null;let t=f.current.getBoundingClientRect(),l=a.naturalW/y.w,n=a.naturalH/y.h;return{x:Math.round((e.clientX-t.left)*l),y:Math.round((e.clientY-t.top)*n)}},N=(e,t)=>{let a=p.current;a&&(a.beginPath(),a.arc(e,t,i,0,2*Math.PI,!0),"paint"===x?(a.globalCompositeOperation="source-over",a.fillStyle="white"):a.globalCompositeOperation="destination-out",a.fill(),a.closePath())};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:"flex justify-between items-center flex-wrap gap-4 p-2 bg-gray-100 rounded",children:(0,l.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,l.jsx)("span",{className:"font-medium text-sm text-gray-700",children:"Brush Size:"}),(0,l.jsx)("input",{type:"range",min:"4",max:"32",value:i,onChange:e=>d(Number(e.target.value)),className:"w-32"}),(0,l.jsx)("input",{type:"number",min:"4",max:"32",value:i,onChange:e=>d(Number(e.target.value)),disabled:!0,className:"w-16 px-2 py-1 text-sm border rounded text-black"})]})}),(0,l.jsx)("div",{className:"tool-container relative border border-dashed p-4 rounded h-[90%] bg-gray-100/80",onContextMenu:e=>e.preventDefault(),children:t?(0,l.jsxs)("div",{children:[(0,l.jsxs)("p",{className:"mt-2 text-black text-sm text-center truncate flex",children:[t.name,(0,l.jsx)("span",{className:"absolute top-1 left-4 bg-red-800 text-white text-xs px-2 py-0.5",children:"w:".concat(a.naturalW," h:").concat(a.naturalH)})]}),(0,l.jsxs)("div",{ref:f,className:"relative border w-fit min-w-[80vh] border-gray-300",style:{cursor:"none"},onMouseDown:e=>{if(0===e.button)m("paint");else{if(2!==e.button)return;m("erase")}e.preventDefault(),u(!0);let t=j(e);t&&N(t.x,t.y)},onMouseMove:e=>{if((e=>{var t;let l=null==(t=b.current)?void 0:t.getContext("2d");if(!l||!f.current||y.w<=1||a.naturalW<=1)return;let n=f.current.getBoundingClientRect(),r=e.clientX-n.left,s=e.clientY-n.top;l.clearRect(0,0,l.canvas.width,l.canvas.height),l.beginPath();let o=i*(y.w/a.naturalW);l.arc(r,s,o>1?o:1,0,2*Math.PI),l.strokeStyle="white",l.lineWidth=1,l.stroke()})(e),!c)return;e.preventDefault();let t=j(e);t&&N(t.x,t.y)},onMouseUp:e=>{if(!c)return;e.preventDefault(),u(!1);let t=p.current;if(!t||!g.current)return;let a=t.getImageData(0,0,g.current.width,g.current.height),l=new ImageData(g.current.width,g.current.height);for(let e=0;e<a.data.length;e+=4)a.data[e+3]>0&&(l.data[e]=255,l.data[e+1]=255,l.data[e+2]=255,l.data[e+3]=255);s(l)},onMouseLeave:()=>{var e;let t=null==(e=b.current)?void 0:e.getContext("2d");if(t&&t.clearRect(0,0,t.canvas.width,t.canvas.height),c){u(!1);let e=p.current;if(!e||!g.current)return;let t=e.getImageData(0,0,g.current.width,g.current.height),a=new ImageData(g.current.width,g.current.height);for(let e=0;e<t.data.length;e+=4)t.data[e+3]>0&&(a.data[e]=255,a.data[e+1]=255,a.data[e+2]=255,a.data[e+3]=255);s(a)}},children:[(0,l.jsx)("img",{ref:h,src:v||"",alt:t.name,onLoad:()=>{if(h.current){let e={w:h.current.clientWidth,h:h.current.clientHeight};w(e);let t=b.current;t&&(t.width=e.w,t.height=e.h),o({naturalW:h.current.naturalWidth,naturalH:h.current.naturalHeight,displayW:e.w,displayH:e.h})}},className:"w-full min-h-[100%] max-h-[100%] object-contain rounded pointer-events-none"}),(0,l.jsx)("canvas",{ref:g,className:"absolute top-0 left-0 w-full h-full opacity-50 pointer-events-none",style:{imageRendering:"pixelated"}}),(0,l.jsx)("canvas",{ref:b,className:"absolute top-0 left-0 w-full h-full pointer-events-none"})]})]}):(0,l.jsx)("div",{className:"p-4 border border-dashed font-bold w-[100%] text-gray-500 text-center",children:"no image selected"})})]})};function m(e){if("segmentation"===e.mode)return(0,l.jsx)(x,{file:e.file,imageSize:e.imageSize,maskData:e.maskData,onMaskChange:e.onMaskChange,onImageLoad:e.onImageLoad});let{file:t,annotations:a,onAnnotationsChange:r,onImageLoad:s,classes:o,onClassesChange:i,keypointCount:d,onKeypointCountChange:c,onModeChange:u}=e,m=(0,n.useRef)(null),h=(0,n.useRef)(null),g=(0,n.useRef)(null),[p,b]=(0,n.useState)(null),[f,y]=(0,n.useState)(null),[w,v]=(0,n.useState)({naturalW:1,naturalH:1,displayW:1,displayH:1}),[j,N]=(0,n.useState)("draw_box"),[k,M]=(0,n.useState)(o[0]),[S,C]=(0,n.useState)(null),[W,H]=(0,n.useState)(0),R=t?URL.createObjectURL(t):null,I=e=>{N(e),u(e)},D=(e,t)=>{if(!h.current)return{x:0,y:0};let a=h.current.getBoundingClientRect();return{x:Math.max(0,Math.min(a.width,e-a.left)),y:Math.max(0,Math.min(a.height,t-a.top))}},E=()=>{if(p&&f&&t&&k){if(f.w<5||f.h<5){y(null),b(null);return}let e=Math.min(f.realX,f.realX+f.realW),t=Math.min(f.realY,f.realY+f.realH),l=Math.abs(f.realW),n=Math.abs(f.realH),s={id:crypto.randomUUID(),classId:k.id,className:k.name,box:{x:e,y:t,w:l,h:n},keypoints:Array(d).fill(null)};r([...a,s]),d>0?(I("add_keypoints"),C(s.id),H(0)):I("draw_box")}y(null),b(null)},_=()=>{if(g.current){let e={naturalW:g.current.naturalWidth,naturalH:g.current.naturalHeight,displayW:g.current.clientWidth,displayH:g.current.clientHeight};v(t=>t.naturalW===e.naturalW&&t.naturalH===e.naturalH&&t.displayW===e.displayW&&t.displayH===e.displayH?t:(s(e),e))}};(0,n.useEffect)(()=>{if(y(null),b(null),I("draw_box"),C(null),H(0),o.length>0){let e=o.find(e=>e.id===(null==k?void 0:k.id));e?M(e):M(o[0])}else M(null);_()},[t,o]),(0,n.useEffect)(()=>{if(!f||!f.realW||w.naturalW<=1)return;let e=w.displayW/w.naturalW,t=w.displayH/w.naturalH;y({...f,x:Math.round(f.realX*e),y:Math.round(f.realY*t),w:Math.round(f.realW*e),h:Math.round(f.realH*t)})},[w]),(0,n.useEffect)(()=>{S&&(a.some(e=>e.id===S)||(I("draw_box"),C(null),H(0)))},[a,S]),(0,n.useEffect)(()=>{let e=e=>{if("add_keypoints"!==j||"Space"!==e.code||e.ctrlKey||!S)return;e.preventDefault();let t=a.find(e=>e.id===S);if(!t)return;let l=[...t.keypoints];l[W]=null,r(a.map(e=>e.id===S?{...e,keypoints:l}:e)),W<d-1?H(W+1):(I("draw_box"),C(null),H(0))};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[j,S,W,d,a,r]);let L=(0,n.useMemo)(()=>{if(w.naturalW<=1||w.naturalH<=1)return[];let e=w.displayW/w.naturalW,t=w.displayH/w.naturalH;return a.map(a=>({...a,displayBox:{x:Math.round(a.box.x*e),y:Math.round(a.box.y*t),w:Math.round(a.box.w*e),h:Math.round(a.box.h*t)},displayKeypoints:a.keypoints.map(a=>a?{x:Math.round(a.x*e),y:Math.round(a.y*t)}:null)}))},[a,w]);return(0,n.useEffect)(()=>{o.length>0&&!o.find(e=>e.id===(null==k?void 0:k.id))?M(o[0]):0===o.length&&M(null)},[o,k]),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"flex justify-between items-center flex-wrap gap-4 p-2 bg-gray-100 rounded",children:[(0,l.jsxs)("div",{className:"flex gap-2 items-center flex-wrap",children:[(0,l.jsx)("span",{className:"font-medium text-sm text-gray-700",children:"Classes:"}),o.map(e=>(0,l.jsxs)("div",{className:"flex items-center rounded ".concat((null==k?void 0:k.id)===e.id?"ring-2 ring-blue-500":""),onContextMenu:t=>{t.preventDefault();var a=e.id;let l=o.find(e=>e.id===a);l&&confirm('Are you sure you want to delete class "'.concat(l.name,'" (ID: ').concat(l.id,")?"))&&i(o.filter(e=>e.id!==a))},children:[(0,l.jsxs)("button",{onClick:()=>M(e),className:"px-2 py-1 text-xs rounded-l font-semibold ".concat((null==k?void 0:k.id)===e.id?"bg-blue-600 text-white":"bg-gray-200 text-gray-800 hover:bg-gray-300"),children:[e.id," "]}),(0,l.jsx)("input",{type:"text",value:e.name,onChange:t=>{var a,l;return a=e.id,l=t.target.value,void i(o.map(e=>e.id===a?{...e,name:l}:e))},className:"px-2 py-1 text-xs w-20 rounded-r border-l border-gray-400 text-black",placeholder:"Class Name"})]},e.id)),(0,l.jsx)("button",{onClick:()=>{let e=o.reduce((e,t)=>Math.max(e,t.id),-1)+1;i([...o,{id:e,name:"c_".concat(e),color:"border-gray-500",bg:"bg-gray-500/20"}])},className:"px-3 py-1 text-xs rounded font-semibold bg-green-500 text-white hover:bg-green-600",children:"+ Class"})]}),(0,l.jsxs)("div",{className:"flex gap-2 items-center flex-wrap",children:[(0,l.jsx)("span",{className:"font-medium text-sm text-gray-700",children:"Keypoints:"}),(0,l.jsxs)("div",{className:"flex gap-1 items-center",children:[Array.from({length:d}).map((e,t)=>(0,l.jsxs)("span",{className:"px-2 py-0.5 text-xs font-mono bg-gray-300 rounded",children:["[",t+1,"]"]},t)),0===d&&(0,l.jsx)("span",{className:"text-xs text-gray-500",children:"no kpts"})]}),d>0&&(0,l.jsx)("button",{onClick:()=>c(Math.max(0,d-1)),className:"px-3 py-1 text-xs rounded font-semibold bg-red-500 text-white hover:bg-red-600",children:"[X]"}),(0,l.jsx)("button",{onClick:()=>c(d+1),className:"px-3 py-1 text-xs rounded font-semibold bg-blue-500 text-white hover:bg-blue-600",children:"+ Add Kpt"})]})]}),(0,l.jsx)("div",{ref:m,className:"tool-container relative border border-dashed p-4 rounded h-[90%] bg-gray-100/80",onMouseDown:e=>{if(!t||!h.current||"draw_box"!==j||0!==e.button||!k)return;let{x:a,y:l}=D(e.clientX,e.clientY);b({x:a,y:l}),y({x:a,y:l,w:0,h:0,realX:0,realY:0,realW:0,realH:0})},onMouseMove:e=>{if(!p||!t||!f)return;let{x:a,y:l}=D(e.clientX,e.clientY),n=Math.abs(a-p.x),r=Math.abs(l-p.y),s=Math.min(p.x,a),o=Math.min(p.y,l),i=w.naturalW/w.displayW,d=w.naturalH/w.displayH;y({...f,x:s,y:o,w:n,h:r,realX:Math.round(s*i),realY:Math.round(o*d),realW:Math.round(n*i),realH:Math.round(r*d)})},onMouseUp:E,onMouseLeave:E,onContextMenu:e=>{if(e.preventDefault(),!t||"add_keypoints"!==j||!S)return;let l=a.find(e=>e.id===S);if(!l)return;let{x:n,y:s}=D(e.clientX,e.clientY),o=w.naturalW/w.displayW,i=w.naturalH/w.displayH,c=Math.round(n*o),u=Math.round(s*i),x=l.box;if(c>=x.x&&c<=x.x+x.w&&u>=x.y&&u<=x.y+x.h){let e=[...l.keypoints];e[W]={x:c,y:u},r(a.map(t=>t.id===S?{...t,keypoints:e}:t)),W<d-1?H(W+1):(I("draw_box"),C(null),H(0))}else alert("Keypoint must be inside the bounding box. Please try again.")},children:t?k?(0,l.jsxs)("div",{children:[(0,l.jsxs)("p",{className:"mt-2 text-black text-sm text-center truncate flex",children:[t.name,(0,l.jsx)("span",{className:"absolute top-1 left-4 bg-red-800 text-white text-xs px-2 py-0.5",children:"w:".concat(w.naturalW," h:").concat(w.naturalH)})]}),(0,l.jsxs)("div",{ref:h,className:"relative border w-fit min-w-[80vh] border-gray-300",style:{cursor:"add_keypoints"===j?"pointer":"crosshair"},children:[(0,l.jsx)("img",{ref:g,src:R||"",alt:t.name,onLoad:_,className:"w-full min-h-[100%] max-h-[100%] object-contain rounded pointer-events-none"}),L.map((e,t)=>{let a=o.find(t=>t.id===e.classId)||o[0];if(!a)return null;let n=e.id===S;return(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"absolute border-2 ".concat(a.color," ").concat(a.bg," ").concat(n?"animate-pulse ring-4 ring-blue-400/50":""),style:{left:e.displayBox.x,top:e.displayBox.y,width:e.displayBox.w,height:e.displayBox.h},children:(0,l.jsxs)("span",{className:"absolute top-0 left-0 ".concat(a.color.replace("border","text")," text-[8px] font-bold px-1 whitespace-nowrap text-white bg-red-600/60 backdrop-blur-sm"),children:["[",t+1,"] ",e.className," ",n?"▶ Kpt ".concat(W+1):""]})}),e.displayKeypoints.map((e,t)=>e&&(0,l.jsx)("div",{className:"absolute w-4 h-4 rounded-full ".concat(a.bg.replace("/20","/80")," ").concat(a.color," border-2 flex items-center justify-center"),style:{left:e.x-8,top:e.y-8},children:(0,l.jsx)("span",{className:"text-xs font-bold",style:{color:a.color.replace("border","text")},children:t+1})},t))]},e.id)}),f&&(0,l.jsx)("div",{className:"absolute border-2 ".concat(k.color," ").concat(k.bg),style:{left:f.x,top:f.y,width:f.w,height:f.h},children:(0,l.jsxs)("span",{className:"absolute top-0 left-0 bg-black/70 text-white text-xs px-1",children:["w:",f.realW,", h:",f.realH]})})]})]}):(0,l.jsx)("div",{className:"p-4 border border-dashed font-bold w-[100%] text-red-500 text-center",children:"Please add at least one class to start labeling."}):(0,l.jsx)("div",{className:"p-4 border border-dashed font-bold w-[100%] text-gray-500 text-center",children:"no image selected"})}),"add_keypoints"===j&&(0,l.jsxs)("div",{className:"p-2 text-center bg-blue-100 text-blue-800 rounded border border-blue-300 font-medium",children:["Right-click INSIDE box ",(0,l.jsxs)("strong",{children:[null==S?void 0:S.substring(0,6),"..."]})," to assign keypoint ",(0,l.jsxs)("strong",{children:[W+1,"/",d]}),". (Press Space to skip)"]})]})}let h=[{id:0,name:"car",color:"border-red-500",bg:"bg-red-500/20"},{id:1,name:"bus",color:"border-blue-500",bg:"bg-blue-500/20"},{id:2,name:"truck",color:"border-green-500",bg:"bg-green-500/20"},{id:3,name:"motorcycle",color:"border-yellow-500",bg:"bg-yellow-500/20"}];function g(){let[e,t]=(0,n.useState)(250),[a,r]=(0,n.useState)(500),[o,c]=(0,n.useState)(!1),x=(0,n.useRef)(null);(0,n.useEffect)(()=>{let e=e=>{if(o&&x.current){let t=x.current.getBoundingClientRect().right-e.clientX;t>250&&t<800&&r(t)}},t=()=>c(!1);return window.addEventListener("mousemove",e),window.addEventListener("mouseup",t),window.addEventListener("mouseleave",t),window.addEventListener("blur",t),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t),window.removeEventListener("mouseleave",t),window.removeEventListener("blur",t)}},[o]);let[g,p]=(0,n.useState)(null),[b,f]=(0,n.useState)([]),[y,w]=(0,n.useState)({naturalW:1,naturalH:1}),[v,j]=(0,n.useState)("detection"),[N,k]=(0,n.useState)(new Map),[M,S]=(0,n.useState)(h),[C,W]=(0,n.useState)(0),[H,R]=(0,n.useState)(!1),I=(0,n.useRef)("draw_box"),[D,E]=(0,n.useState)(new Map),_=N.get((null==g?void 0:g.name)||"")||[],L=D.get((null==g?void 0:g.name)||"")||null,U=e=>{if(!g)return;let t=new Map(N);t.set(g.name,e),k(t)},F=(0,n.useRef)(null);return(0,n.useEffect)(()=>{let e=e=>{var t,a;if("Space"!==e.code||e.ctrlKey||(e.preventDefault(),null==(t=F.current)||t.nextImage()),"Space"===e.code&&e.ctrlKey&&(e.preventDefault(),null==(a=F.current)||a.prevImage()),"segmentation"!==v&&"add_keypoints"===I.current)return};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[v]),(0,l.jsxs)("div",{ref:x,className:"".concat(s().className," ").concat(i().className," font-sans flex h-screen bg-gray-100"),children:[(0,l.jsxs)("div",{style:{width:e},className:"bg-gray-200 transition-all duration-300 flex flex-col shadow-lg",children:[(0,l.jsx)("button",{onClick:()=>t(100===e?300:100),className:"p-2 bg-gray-600 text-white font-bold hover:bg-gray-700",children:100===e?">>":"<<"}),e>0&&(0,l.jsx)("div",{className:"p-2 flex-1",children:(0,l.jsx)(d,{ref:F,onFileSelect:e=>{p(e),e&&"segmentation"===v&&y.naturalW>1&&y.naturalH},onFilesChange:f,isWidthCollapsed:100===e,mode:v,onModeChange:j})})]}),(0,l.jsxs)("div",{className:"flex-1 bg-white p-2 flex flex-col gap-2",children:[(0,l.jsx)(m,{file:g,onImageLoad:e=>{e.naturalW>1&&e.naturalH>1&&(w({naturalW:e.naturalW,naturalH:e.naturalH}),"segmentation"===v&&g&&E(t=>{let a=t.get(g.name);if(a){if(a.width!==e.naturalW||a.height!==e.naturalH){let a=new ImageData(e.naturalW,e.naturalH),l=new Map(t);return l.set(g.name,a),l}}else{let a=new ImageData(e.naturalW,e.naturalH),l=new Map(t);return l.set(g.name,a),l}return t}))},mode:v,annotations:_,onAnnotationsChange:U,classes:M,onClassesChange:e=>{S(e)},keypointCount:C,onKeypointCountChange:e=>{e!==C&&(W(e),k(new Map),e>C&&e>0&&(R(!0),setTimeout(()=>R(!1),2e3)))},onModeChange:e=>{I.current=e},imageSize:y,maskData:L,onMaskChange:e=>{if(!g)return;let t=new Map(D);t.set(g.name,e),E(t)}}),"detection"===v?(0,l.jsx)("div",{className:"mt-2 p-3 border border-gray-300 rounded bg-gray-50 text-sm text-gray-700 shadow-sm",children:(0,l.jsxs)("div",{className:"flex flex-col items-start gap-2",children:[(0,l.jsxs)("span",{className:"flex items-center gap-2",children:[(0,l.jsx)("kbd",{className:"px-2 py-1 bg-gray-200 border border-gray-300 text-gray-800 rounded font-mono text-xs",children:"Space"}),": Next Image"]}),(0,l.jsxs)("span",{className:"flex items-center gap-2 rounded py-1 pr-2 transition-all duration-100 ".concat(H?"flash-yellow":"bg-transparent"),children:[(0,l.jsx)("kbd",{className:"px-2 py-1 bg-gray-200 border border-gray-300 text-gray-800 rounded font-mono text-xs",children:"Space (add kpt)"}),": Skip current Keypoint"]}),(0,l.jsxs)("span",{className:"flex items-center gap-2",children:[(0,l.jsx)("kbd",{className:"px-2 py-1 bg-gray-200 border border-gray-300 text-gray-800 rounded font-mono text-xs",children:"Ctrl + Space"}),": Previous Image"]}),(0,l.jsxs)("span",{className:"flex items-center gap-2",children:[(0,l.jsx)("kbd",{className:"px-2 py-1 bg-gray-200 border border-gray-300 text-gray-800 rounded font-mono text-xs",children:"Left-click Drag"}),": Draw Bounding Box"]}),(0,l.jsxs)("span",{className:"flex items-center gap-2",children:[(0,l.jsx)("kbd",{className:"px-2 py-1 bg-gray-200 border border-gray-300 text-gray-800 rounded font-mono text-xs",children:"Right-click"}),": Assign Keypoint(s) (after drawing box)"]}),(0,l.jsxs)("span",{className:"flex items-center gap-2",children:[(0,l.jsx)("kbd",{className:"px-2 py-1 bg-gray-200 border border-gray-300 text-gray-800 rounded font-mono text-xs",children:"Right-click [classID]"}),": Delete class"]})]})}):(0,l.jsx)("div",{className:"mt-2 p-3 border border-gray-300 rounded bg-gray-50 text-sm text-gray-700 shadow-sm",children:(0,l.jsxs)("div",{className:"flex flex-col items-start gap-2",children:[(0,l.jsxs)("span",{className:"flex items-center gap-2",children:[(0,l.jsx)("kbd",{className:"px-2 py-1 bg-gray-200 border border-gray-300 text-gray-800 rounded font-mono text-xs",children:"Space"}),": Next Image"]}),(0,l.jsxs)("span",{className:"flex items-center gap-2",children:[(0,l.jsx)("kbd",{className:"px-2 py-1 bg-gray-200 border border-gray-300 text-gray-800 rounded font-mono text-xs",children:"Ctrl + Space"}),": Previous Image"]}),(0,l.jsxs)("span",{className:"flex items-center gap-2",children:[(0,l.jsx)("kbd",{className:"px-2 py-1 bg-gray-200 border border-gray-300 text-gray-800 rounded font-mono text-xs",children:"Left-click Drag"}),": Paint Mask"]}),(0,l.jsxs)("span",{className:"flex items-center gap-2",children:[(0,l.jsx)("kbd",{className:"px-2 py-1 bg-gray-200 border border-gray-300 text-gray-800 rounded font-mono text-xs",children:"Right-click Drag"}),": Erase Mask"]})]})})]}),(0,l.jsxs)("div",{style:{width:a},className:"relative bg-gray-200 shadow-inner",children:[(0,l.jsx)("div",{className:"p-2",children:(0,l.jsx)(u,{imageName:(null==g?void 0:g.name)||"",imageSize:y,mode:v,annotations:_,onAnnotationsChange:U,classes:M,allImageFiles:b,onBulkAnnotationsUpdate:e=>{k(new Map([...N,...e]))},keypointCount:C,maskData:L})}),(0,l.jsx)("div",{onMouseDown:()=>c(!0),className:"absolute left-0 top-0 h-full w-1.5 cursor-col-resize bg-transparent hover:bg-blue-400 transition-colors duration-200"})]})]})}}},e=>{e.O(0,[636,593,792],()=>e(e.s=6760)),_N_E=e.O()}]);